package routing

import io.ktor.server.response.*
import io.ktor.server.routing.*
import io.ktor.server.request.*
import io.ktor.server.sessions.*
import io.ktor.http.*
import com.opendronediary.model.Pilot
import com.opendronediary.model.UserSession
import com.opendronediary.service.PilotService
import io.ktor.server.html.respondHtml
import kotlinx.html.*
import utils.GTMHelper.addGTMBodyScript
import utils.PolicyHelper.addFooter
import routing.bootstrapHead

fun Route.configurePilotRouting(pilotService: PilotService) {
    // „Éë„Ç§„É≠„ÉÉ„ÉàÁÆ°ÁêÜ API - Authentication required
    route("/pilots") {
        get {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respond(HttpStatusCode.Unauthorized)
                return@get
            }
            call.respond(pilotService.getAllByUserId(session.userId))
        }
        get("/{id}") {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respond(HttpStatusCode.Unauthorized)
                return@get
            }
            val id = call.parameters["id"]?.toIntOrNull()
            val pilot = id?.let { pilotService.getByIdAndUserId(it, session.userId) }
            if (pilot != null) {
                call.respond(pilot)
            } else {
                call.respond(HttpStatusCode.NotFound)
            }
        }
        post {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respond(HttpStatusCode.Unauthorized)
                return@post
            }
            val contentType = call.request.contentType()
            if (contentType.match(ContentType.Application.FormUrlEncoded)) {
                val params = call.receiveParameters()
                val name = params["name"]?.trim() ?: ""
                
                if (name.isEmpty()) {
                    call.respond(HttpStatusCode.BadRequest, "„Éë„Ç§„É≠„ÉÉ„ÉàÂêç„ÅØÂøÖÈ†à„Åß„Åô")
                    return@post
                }
                
                val created = pilotService.add(Pilot(
                    id = 0,
                    name = name,
                    userId = session.userId
                ))
                call.respondRedirect("/pilots/ui")
            } else {
                val pilot = call.receive<Pilot>()
                val created = pilotService.add(pilot.copy(userId = session.userId))
                call.respond(HttpStatusCode.Created, created)
            }
        }
        put("/{id}") {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respond(HttpStatusCode.Unauthorized)
                return@put
            }
            val id = call.parameters["id"]?.toIntOrNull()
            val pilot = call.receive<Pilot>()
            if (id != null && pilotService.update(id, pilot, session.userId)) {
                call.respond(HttpStatusCode.OK)
            } else {
                call.respond(HttpStatusCode.NotFound)
            }
        }
        delete("/{id}") {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respond(HttpStatusCode.Unauthorized)
                return@delete
            }
            val id = call.parameters["id"]?.toIntOrNull()
            if (id != null && pilotService.delete(id, session.userId)) {
                call.respond(HttpStatusCode.NoContent)
            } else {
                call.respond(HttpStatusCode.NotFound)
            }
        }
    }
    
    // „Éë„Ç§„É≠„ÉÉ„ÉàÁÆ°ÁêÜ UI (HTMLÁîªÈù¢) - Authentication required
    route("/pilots/ui") {
        get {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respondRedirect("/login")
                return@get
            }
            val pilots = pilotService.getAllByUserId(session.userId)
            call.respondHtml {
                head { 
                    bootstrapHead("„Éë„Ç§„É≠„ÉÉ„ÉàÁÆ°ÁêÜ")
                }
                body(classes = "d-flex flex-column min-vh-100") {
                    addGTMBodyScript()
                    nav(classes = "navbar navbar-expand-lg navbar-dark bg-dark") {
                        div(classes = "container") {
                            a(href = "/", classes = "navbar-brand") { +"üõ©Ô∏è OpenDroneDiary" }
                            div(classes = "navbar-nav ms-auto") {
                                span(classes = "navbar-text me-3") { +"„É≠„Ç∞„Ç§„É≥‰∏≠: ${session.username}" }
                                a(href = "/logout", classes = "btn btn-outline-light btn-sm") { +"„É≠„Ç∞„Ç¢„Ç¶„Éà" }
                            }
                        }
                    }
                    div(classes = "container mt-4") {
                        div(classes = "row") {
                            div(classes = "col-12") {
                                div(classes = "card") {
                                    div(classes = "card-header d-flex justify-content-between align-items-center") {
                                        h1(classes = "card-title mb-0") { +"üë®‚Äç‚úàÔ∏è „Éë„Ç§„É≠„ÉÉ„ÉàÁÆ°ÁêÜ" }
                                        div {
                                            a(href = "/flightlogs/ui", classes = "btn btn-outline-primary btn-sm me-2") { +"È£õË°åË®òÈå≤„Å∏" }
                                            a(href = "/", classes = "btn btn-outline-secondary btn-sm") { +"„Éà„ÉÉ„Éó„Å∏" }
                                        }
                                    }
                                    div(classes = "card-body") {
                                        if (pilots.isEmpty()) {
                                            div(classes = "alert alert-info") { +"„Åæ„Å†„Éë„Ç§„É≠„ÉÉ„Éà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰∏ã„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâÊñ∞Ë¶èÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" }
                                        } else {
                                            div(classes = "table-responsive") {
                                                table(classes = "table table-striped table-hover") {
                                                    thead(classes = "table-dark") {
                                                        tr {
                                                            th { +"ID" }
                                                            th { +"„Éë„Ç§„É≠„ÉÉ„ÉàÊ∞èÂêç" }
                                                            th { +"ÁôªÈå≤Êó•ÊôÇ" }
                                                            th(classes = "text-center") { +"Êìç‰Ωú" }
                                                        }
                                                    }
                                                    tbody {
                                                        pilots.forEach { pilot ->
                                                            tr {
                                                                td { +pilot.id.toString() }
                                                                td { 
                                                                    strong { +pilot.name }
                                                                }
                                                                td { 
                                                                    pilot.createdAt?.let { 
                                                                        +it.toString().substring(0, 19).replace("T", " ")
                                                                    } ?: "‰∏çÊòé" 
                                                                }
                                                                td(classes = "text-center") {
                                                                    a(href = "/pilots/ui/${pilot.id}", classes = "btn btn-sm btn-outline-primary me-2") { +"Á∑®ÈõÜ" }
                                                                    form(action = "/pilots/ui/${pilot.id}", method = FormMethod.post, classes = "d-inline") {
                                                                        hiddenInput { name = "_method"; value = "delete" }
                                                                        submitInput(classes = "btn btn-sm btn-outline-danger") { 
                                                                            value = "ÂâäÈô§"
                                                                            attributes["onclick"] = "return confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\\n\\nÊ≥®ÊÑè: „Åì„ÅÆ„Éë„Ç§„É≠„ÉÉ„Éà„ÇíÂèÇÁÖß„Åó„Å¶„ÅÑ„ÇãÈ£õË°åË®òÈå≤„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Éá„Éº„Çø„Å´‰∏çÊï¥Âêà„ÅåÁîü„Åò„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ')"
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                
                                div(classes = "card mt-4") {
                                    div(classes = "card-header") {
                                        h2(classes = "card-title mb-0") { +"Êñ∞Ë¶è„Éë„Ç§„É≠„ÉÉ„ÉàÁôªÈå≤" }
                                    }
                                    div(classes = "card-body") {
                                        form(action = "/pilots/ui", method = FormMethod.post) {
                                            div(classes = "row") {
                                                div(classes = "col-md-8 mb-3") {
                                                    label(classes = "form-label") { +"„Éë„Ç§„É≠„ÉÉ„ÉàÊ∞èÂêç" }
                                                    textInput(classes = "form-control") { 
                                                        name = "name"
                                                        placeholder = "„Éë„Ç§„É≠„ÉÉ„Éà„ÅÆÊ∞èÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                                        required = true
                                                        maxLength = "100"
                                                    }
                                                }
                                                div(classes = "col-md-4 mb-3 d-flex align-items-end") {
                                                    submitInput(classes = "btn btn-success w-100") { value = "„Éë„Ç§„É≠„ÉÉ„Éà„ÇíÁôªÈå≤" }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    addFooter()
                }
            }
        }
        
        get("/{id}") {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respondRedirect("/login")
                return@get
            }
            val id = call.parameters["id"]?.toIntOrNull()
            val pilot = id?.let { pilotService.getByIdAndUserId(it, session.userId) }
            if (pilot == null) {
                call.respond(HttpStatusCode.NotFound)
                return@get
            }
            call.respondHtml {
                head { 
                    bootstrapHead("„Éë„Ç§„É≠„ÉÉ„ÉàÁ∑®ÈõÜ")
                }
                body {
                    addGTMBodyScript()
                    nav(classes = "navbar navbar-expand-lg navbar-dark bg-dark") {
                        div(classes = "container") {
                            a(href = "/", classes = "navbar-brand") { +"üõ©Ô∏è OpenDroneDiary" }
                            div(classes = "navbar-nav ms-auto") {
                                a(href = "/pilots/ui", classes = "btn btn-outline-light btn-sm me-2") { +"‰∏ÄË¶ß„Å∏Êàª„Çã" }
                                a(href = "/logout", classes = "btn btn-outline-light btn-sm") { +"„É≠„Ç∞„Ç¢„Ç¶„Éà" }
                            }
                        }
                    }
                    div(classes = "container mt-4") {
                        div(classes = "row justify-content-center") {
                            div(classes = "col-md-6") {
                                div(classes = "card") {
                                    div(classes = "card-header") {
                                        h1(classes = "card-title mb-0") { +"„Éë„Ç§„É≠„ÉÉ„ÉàÁ∑®ÈõÜ" }
                                    }
                                    div(classes = "card-body") {
                                        form(action = "/pilots/ui/${pilot.id}", method = FormMethod.post) {
                                            hiddenInput { name = "_method"; value = "put" }
                                            div(classes = "mb-3") {
                                                label(classes = "form-label") { +"„Éë„Ç§„É≠„ÉÉ„ÉàÊ∞èÂêç" }
                                                textInput(classes = "form-control") { 
                                                    name = "name"
                                                    value = pilot.name
                                                    required = true
                                                    maxLength = "100"
                                                }
                                            }
                                            div(classes = "d-grid gap-2 d-md-block") {
                                                submitInput(classes = "btn btn-primary") { value = "Êõ¥Êñ∞" }
                                            }
                                        }
                                        hr()
                                        form(action = "/pilots/ui/${pilot.id}", method = FormMethod.post) {
                                            hiddenInput { name = "_method"; value = "delete" }
                                            div(classes = "d-grid") {
                                                submitInput(classes = "btn btn-danger") { 
                                                    value = "ÂâäÈô§"
                                                    attributes["onclick"] = "return confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\\n\\nÊ≥®ÊÑè: „Åì„ÅÆ„Éë„Ç§„É≠„ÉÉ„Éà„ÇíÂèÇÁÖß„Åó„Å¶„ÅÑ„ÇãÈ£õË°åË®òÈå≤„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Éá„Éº„Çø„Å´‰∏çÊï¥Âêà„ÅåÁîü„Åò„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ')"
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // HTML„Éï„Ç©„Éº„É†„Åã„Çâ„ÅÆPOST„É™„ÇØ„Ç®„Çπ„Éà„ÇíPUT/DELETE/POST„Å´ÊåØ„ÇäÂàÜ„Åë
        post("/{id}") {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respondRedirect("/login")
                return@post
            }
            val id = call.parameters["id"]?.toIntOrNull()
            val params = call.receiveParameters()
            val method = params["_method"]
            when (method) {
                "put" -> {
                    if (id != null) {
                        val name = params["name"]?.trim() ?: ""
                        if (name.isEmpty()) {
                            call.respond(HttpStatusCode.BadRequest, "„Éë„Ç§„É≠„ÉÉ„ÉàÂêç„ÅØÂøÖÈ†à„Åß„Åô")
                            return@post
                        }
                        val updated = pilotService.update(id, Pilot(
                            id = id,
                            name = name,
                            userId = session.userId
                        ), session.userId)
                        if (updated) {
                            call.respondRedirect("/pilots/ui")
                        } else {
                            call.respond(HttpStatusCode.NotFound)
                        }
                    } else {
                        call.respond(HttpStatusCode.BadRequest)
                    }
                }
                "delete" -> {
                    if (id != null && pilotService.delete(id, session.userId)) {
                        call.respondRedirect("/pilots/ui")
                    } else {
                        call.respond(HttpStatusCode.NotFound)
                    }
                }
                else -> call.respond(HttpStatusCode.BadRequest)
            }
        }
        
        // Êñ∞Ë¶è‰ΩúÊàê„Éï„Ç©„Éº„É†Áî®
        post {
            val session = call.sessions.get<UserSession>()
            if (session == null) {
                call.respondRedirect("/login")
                return@post
            }
            val contentType = call.request.contentType()
            if (contentType.match(ContentType.Application.FormUrlEncoded)) {
                val params = call.receiveParameters()
                val name = params["name"]?.trim() ?: ""
                
                if (name.isEmpty()) {
                    call.respond(HttpStatusCode.BadRequest, "„Éë„Ç§„É≠„ÉÉ„ÉàÂêç„ÅØÂøÖÈ†à„Åß„Åô")
                    return@post
                }
                
                val created = pilotService.add(Pilot(
                    id = 0,
                    name = name,
                    userId = session.userId
                ))
                call.respondRedirect("/pilots/ui")
            } else {
                val pilot = call.receive<Pilot>()
                val created = pilotService.add(pilot.copy(userId = session.userId))
                call.respond(HttpStatusCode.Created, created)
            }
        }
    }
}